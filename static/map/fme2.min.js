$('#fme2').html(`<div id="fme2_container"><div class="fme2 fme2-bottom display-flex group-vertical btn-icon"role="group"><a class="fme2-button btn-icon"id="schedule_runer_btn"onclick="schedule_RUN_SWITCHER();"><i class="material-icons">event_note</i></a><a class="fme2-button btn-icon"id="navi_btn"onclick="naviModeSwitch();"><i class="material-icons">near_me</i></a><a class="fme2-button btn-icon"id="search_room_btn"onclick="onSearchRoomSwitch();"><i class="material-icons">search</i></a><a class="fme2-button btn-icon"id="level_selectors_btn"onclick="level_selectors_switch();"><i class="material-icons">list</i></a></div><div class="fme2 fme2-bottom display-flex"style="right: 0;"><div id="build_selector"class="fme2 display-flex group-vertical"></div><div id="level_selector"class="fme2 display-flex group-vertical"></div></div><div class="fme2 fme2-bottom display-flex group-vertical"style="position: absolute; left: 43px"id="navi_selecter"></div><div style="position: absolute; left: 0; margin-top: 0;"><!--SCHEDULE--><div class="fme2 group-horizontal"id="schedule_control"><div class="fme2 display-flex group-horizontal fme2-grp-dd"><div class="fme2-grp-dd"><div class="fme2-button btn-stand btn-dd"><span id="schedule_drop_down_day">00</span></div><div class="fme2 dd-menu group-vertical"><div class="fme2-button dd-item"onclick="schedule_set_day(1,true);">ПН</div><div class="fme2-button dd-item"onclick="schedule_set_day(2,true);">ВТ</div><div class="fme2-button dd-item"onclick="schedule_set_day(3,true);">СР</div><div class="fme2-button dd-item"onclick="schedule_set_day(4,true);">ЧТ</div><div class="fme2-button dd-item"onclick="schedule_set_day(5,true);">ПТ</div><div class="fme2-button dd-item"onclick="schedule_set_day(6,true);">СБ</div></div></div><div class="fme2-grp-dd"><div class="fme2-button btn-stand btn-dd"><span id="schedule_drop_down_pair">00</span></div><div class="fme2 dd-menu group-vertical"><div class="fme2-button dd-item"onclick="schedule_set_pair(1,true);">1 пара</div><div class="fme2-button dd-item"onclick="schedule_set_pair(2,true);">2 пара</div><div class="fme2-button dd-item"onclick="schedule_set_pair(3,true);">3 пара</div><div class="fme2-button dd-item"onclick="schedule_set_pair(4,true);">4 пара</div><div class="fme2-button dd-item"onclick="schedule_set_pair(5,true);">5 пара</div><div class="fme2-button dd-item"onclick="schedule_set_pair(6,true);">6 пара</div><div class="fme2-button dd-item"onclick="schedule_set_pair(7,true);">7 пара</div></div></div></div><div class="fme2 display-flex group-horizontal fme2-grp-dd"><div class="fme2-button btn-stand"onclick="schedule_prev_week();">&#8678;</div><div class="fme2-button btn-stand"data-toggle="tooltip"data-placement="bottom"title=""data-original-title="Сброс"id="week_num"onclick="schedule_cur_week();">00</div><div class="fme2-button btn-stand"onclick="schedule_next_week();">&#8680;</div></div></div><!--SEARCH ROOM--><div class="fme2 group-horizontal"id="search_room"><div class="fme2-grp-dd"><div class="fme2-button btn-stand btn-dd"><span id="search_room_build">7</span></div><div class="fme2 dd-menu group-vertical"><div class="fme2-button dd-item"onclick="setSearchRoomBuild(1);">1</div><div class="fme2-button dd-item"onclick="setSearchRoomBuild(2);">2</div><div class="fme2-button dd-item"onclick="setSearchRoomBuild(3);">3</div><div class="fme2-button dd-item"onclick="setSearchRoomBuild(4);">4</div><div class="fme2-button dd-item"onclick="setSearchRoomBuild(5);">5</div><div class="fme2-button dd-item"onclick="setSearchRoomBuild(6);">6</div><div class="fme2-button dd-item"onclick="setSearchRoomBuild(7);">7</div></div></div><input title="Аудитория"class="fme2-input"type="text"id="search_room_name"/><div class="fme2-button fme2-grp-dd btn-stand"onclick="onSearchRoom();"style="width: 40px; min-width: 40px; padding-top: 2px"><i class="material-icons">search</i></div><div class="fme2 fme2-grp-dd group-horizontal"id="navi"style="margin-top: 0"><div class="fme2-button fme2-grp-dd btn-stand"style="margin: 0"onclick="onNaviSet('from');">Отсюда</div><div class="fme2-button fme2-grp-dd btn-stand"style="margin: 0"onclick="onNaviSet('to');">Сюда</div></div><div id="navi_sets"class="fme2-navi-from-to"><p><span class="label fme2-navi_sets">Откуда:<span id="navi_set_from"></span></span></p><p><span class="label fme2-navi_sets">Куда:<span id="navi_set_to"></span></span></p></div></div></div><div class="fme2-modal display-flex"id="modal_sch_room"style="display: none"><div class="fme2-modal-dialog"><div class="fme2-modal-content"><p><h4><b id="modal_sch_room_title">7-105</b></h4></p><hr><div id="modal_sch_room_teachers"></div><hr><div id="modal_sch_room_groups">Groups</div><hr><div class="fme2-button btn-modal"onclick="$('#modal_sch_room').hide()">Закрыть</div></div></div></div><div id="render_container"></div></div>`);console.log('FME2 BUILD Fri Mar 03 19:42:17 2017');var X={get INT32_MAX(){return 4294967296},BIND:function(func,context){return function(){return func.apply(context,arguments);};},STR_FILL_TO_LENGTH:function(str,char,count,side){var rpt='';count-=str.length;for(var i=0;i<count;i++)rpt+=char;if(side=='left')return rpt+str;if(side=='right')return str+rpt;return undefined;},GET_VALUES_OF_DIC_BY_KEY_VALUE:function(array,key,value){var objs=[];for(var k in array)if(array[k][key]==value)objs.push(array[k]);return objs;},GET_VALUES_OF_KEYS_IN_DIC:function(array,key){var ids=[];for(var k in array)ids.push(array[k][key]);return ids;},FILT_DIC_BY_KEYS:function(array,key_array){var objs=[];for(var k in key_array)objs.push(array[k]);return objs;},PROCONF:function(mode,text){var pc;if(mode=='promt')pc=prompt(text);if(mode=='confirm')pc=confirm(text);if(pc==""||pc==void 0)return undefined;return pc;},GET_URL_PARAMETER:function(sParam){var sPageURL=decodeURIComponent(window.location.search.substring(1));var sURLVariables=sPageURL.split('&');var sParameterName;var i;for(i=0;i<sURLVariables.length;i++){sParameterName=sURLVariables[i].split('=');if(sParameterName[0]===sParam){return sParameterName[1]===undefined?true:sParameterName[1];}}},GEBI:function(id){return document.getElementById(id);},TFU:function(tfu,t,f){return tfu==t?true:(tfu==f?false:undefined);},ID21:function(id1,id2){if(id1<id2)return id1*100000000+id2;else return id2*100000000+id1;},FORMAT:function(string,array,replace){if(replace==void 0)replace="{x}";string=String(string).split(replace);var result=string[0];for(var i in array){i=parseInt(i);result+=array[i]+string[i+1];}return result;},VOID0:function(args){for(var a in args)if(args[a]==void 0)return true;return false;},FULLHTML:function(id){return $(id).wrap('<div>').parent().html();}};var FME2={};FME2.__FME2_ICON_DATA=function(root_folder){var source=[{name:'projector',file:'projector.png'},{name:'transfer',file:'transfer.png'},{name:'male',file:'human-male.png'},{name:'female',file:'human-female.png'},{name:'lift',file:'swap-vertical.png'},{name:'stair',file:'stair.png'},{name:'male-female',file:'human-male-female.png'}];this.byname={};this.undefined_file='undefined.png';this.sourcing=function(){this.byname={};this.undefined_file=root_folder+this.undefined_file;for(var i in source){source[i].file=root_folder+source[i].file;this.byname[source[i].name]=source[i];}};this.processing=function(func,key){for(var i in source)source[i].key=func(source[i]);};this.sourcing();};FME2.ICON_DATA=new FME2.__FME2_ICON_DATA(FME2CONFIG.icon_path);FME2.CSSXD={createCSS3DRenderer:function(container,width,height){var renderer=new THREE.CSS3DRenderer();container.appendChild(renderer.domElement);return renderer;},createCSS3DSprite:function(src,position,el,el_style){var img=document.createElement('img');img.src=src;for(var k in el)img[k]=el[k];for(var k in el_style)img.style[k]=el_style[k];var object=new THREE.CSS3DSprite(img);object.position.copy(position);object.matrixAutoUpdate=false;object.updateMatrix();return object;},createCSS3DObject:function(content,position,el,el_style){var element=document.createElement('div');for(var k in el)element[k]=el[k];for(var k in el_style)element.style[k]=el_style[k];element.textContent=content;var object=new THREE.CSS3DObject(element);object.position.copy(position);return object;},createCSS2DRenderer:function(container,width,height){var renderer=new THREE.CSS2DRenderer();renderer.domElement.style.position='absolute';renderer.domElement.style.pointerEvents='none';container.appendChild(renderer.domElement);return renderer;},createCSS2DObject:function(content,position,el,el_style){var element=document.createElement('div');for(var k in el)element[k]=el[k];for(var k in el_style)element.style[k]=el_style[k];element.innerHTML=content;var object=new THREE.CSS2DObject(element);object.position.copy(position);return object;}};var room_obj3d={};var background=null;var assign_surfroom={};function create_scene_level(){var scn=new THREE.Scene();var directionalLight=new THREE.DirectionalLight(0x999999);directionalLight.position.x=0.5;directionalLight.position.y=0.5;directionalLight.position.z=0.5;directionalLight.position.normalize();scn.add(directionalLight);directionalLight=new THREE.DirectionalLight(0x999999);directionalLight.position.x=-0.5;directionalLight.position.y=0.5;directionalLight.position.z=0.5;directionalLight.position.normalize();scn.add(directionalLight);directionalLight=new THREE.DirectionalLight(0x444444);directionalLight.position.x=-0.5;directionalLight.position.y=0.5;directionalLight.position.z=-0.5;directionalLight.position.normalize();scn.add(directionalLight);directionalLight=new THREE.DirectionalLight(0x444444);directionalLight.position.x=0.5;directionalLight.position.y=0.5;directionalLight.position.z=-0.5;directionalLight.position.normalize();scn.add(directionalLight);var back_size=20000;var back_color=data.options.surface_color;var geometry=new THREE.PlaneGeometry(back_size,back_size);var material=new THREE.MeshLambertMaterial({color:back_color,side:THREE.FrontSide});var surface=new THREE.Mesh(geometry,material);surface.position.set(0,-opt.wall_height/2+opt.surface_y,0);surface.rotation.set(-Math.PI/2,0,0);surface.userData={type:'background'};surface.name='background';background=surface;scn.add(surface);return scn;}function level_blid(lvl){return lvl.build_id*1000+lvl.level_id;}function load_level(build_id,level_id){load_packed_level(data.builds[parseInt(build_id)][parseInt(level_id)]);}function load_build_level(build_id,level_id){select_build(build_id,load_level,[build_id,level_id]);}function load_packed_level(lvl){$('#select-build-'+current_level.build_id).removeClass('active');$('#select-level-'+current_level.level_id).removeClass('active');$('#select-build-'+lvl.build_id).addClass('active');$('#select-level-'+lvl.level_id).addClass('active');console.time('load_packed_level');if(lvl==void 0)return;if(css_renderer!=void 0)css_renderer.domElement.style.display='none';if(schedule_prm.enabled&&current_level!=void 0)clear_schedule_select();current_build_id=lvl.build_id;var level=loaded_levels[level_blid(lvl)];if(level!=undefined){scene=level.scene;css_renderer=level.css_renderer;css_renderer.domElement.style.display='block';draw_navi(level.build_id,level.level_id);current_level=level;look_at_me();if(schedule_prm.enabled)schedule_changed_level();console.log('Loaded cached level '+level_blid(lvl));console.timeEnd('load_packed_level');return;}level={level_id:lvl.level_id,build_id:lvl.build_id};var material,geometry,mesh;level.scene=create_scene_level();scene=level.scene;scene.name="scene-"+level.build_id+'-'+level.level_id;css_renderer=FME2.CSSXD.createCSS2DRenderer(container);css_renderer.setSize(render_width(),render_height());css_renderer.domElement.style.top=renderer.domElement.offsetTop+'px';level.css_renderer=css_renderer;draw_navi(level.build_id,level.level_id);var main_wall_color=data.colors.subtypes[data.colors.type_ids.WALL[0]].color;level.nodes={};var center=new THREE.Vector3();var node_count=0;for(var n in lvl.nodes){var nd=lvl.nodes[n];var p=nd.position;var node={id:nd.id,position:new THREE.Vector3(p.x,opt.level_offset_y,p.z),get color(){return this.scene_obj.material.color.getHex();},set color(c){return this.scene_obj.material.color.setHex(c);},scene_obj:new THREE.Mesh(new THREE.CylinderGeometry(opt.wall_width/2,opt.wall_width/2,opt.wall_height*opt.node_hei,8),new THREE.MeshLambertMaterial({color:main_wall_color}))};center.add(node.position);node_count++;node.scene_obj.userData={type:'node',id:nd.id};node.scene_obj.name='node-'+nd.id;node.scene_obj.position.copy(node.position);level.nodes[node.id]=node;}center.divideScalar(node_count);controls.target=center;controls.update();level.walls={};var p0=new THREE.Vector3(1,0,0);for(var w in lvl.walls){var wl=lvl.walls[w];var p1=level.nodes[wl.nodes_ids[0]].position;var p2=level.nodes[wl.nodes_ids[1]].position;var l=p1.distanceTo(p2);var a=p1.clone().sub(p2).setY(0).angleTo(p0);if(p1.length()>p2.length())a=Math.PI*2-a;var p=p1.clone().add(p2).divideScalar(2).setY(opt.level_offset_y);var wall={id:wl.id,position:p,height:data.wall_heights[wl.color_id],get color(){return this.scene_obj.material.color.getHex();},set color(c){return this.scene_obj.material.color.setHex(c);},scene_obj:new THREE.Mesh(new THREE.BoxGeometry(l,opt.wall_height*data.wall_heights[wl.color_id],opt.wall_width),new THREE.MeshLambertMaterial({color:main_wall_color}))};wall.scene_obj.userData={type:'wall',id:wl.id};wall.scene_obj.name='wall-'+wl.id;wall.scene_obj.position.set(p.x,-opt.wall_height*(1-wall.height)/2+opt.level_offset_y,p.z);wall.scene_obj.rotation.set(0,a,0);level.walls[wall.id]=wall;}for(var n in lvl.nodes){var wids=lvl.nodes[n].wall_ids;var height=0;var h;for(var k in wids){h=level.walls[wids[k]].height;if(h>height)height=h}if(height<1){var obj=level.nodes[lvl.nodes[n].id].scene_obj;obj.scale.setY(height);obj.position.setY(-opt.wall_height*(1-height)/2+opt.level_offset_y);}}for(var d in lvl.doors){var door=lvl.doors[d];var wall=level.walls[door.wall_id];var p=new THREE.Vector3(door.position.x,-opt.door_top*opt.wall_height+opt.level_offset_y,door.position.z);var pn=level.nodes[lvl.walls[wall.id].nodes_ids[0]].scene_obj.position;var a=p.clone().sub(pn).angleTo(p0);var dm=new THREE.Mesh(new THREE.BoxGeometry(data.options.door_length*data.options.px_zoom,opt.wall_height,opt.wall_width));dm.userData={type:'door',id:door.id};dm.name='door-'+door.id;dm.position.copy(p);dm.rotation.copy(wall.scene_obj.rotation);var wm=wall.scene_obj;scene.remove(wm);var csgw=new ThreeBSP(wm);var csgd=new ThreeBSP(dm);csgw=csgw.subtract(csgd);wm=csgw.toMesh(new THREE.MeshLambertMaterial({color:wall.scene_obj.material.color.getHex()}));wall.scene_obj=wm;wall.scene_obj.userData={type:'wall',id:wall.id};wall.scene_obj.name='wall-'+wall.id;if(door.visible!=false){dm.position.setY(-opt.wall_height*opt.door_top/2+opt.level_offset_y);dm.scale.setZ(opt.door_width);dm.scale.setY(1-opt.door_top);dm.material.color.setHex(opt.door_color);scene.add(dm);}}level.surfaces={};for(var s in lvl.surfaces){var sr=lvl.surfaces[s];var californiaPts=[];for(var k in sr.points)californiaPts.push(new THREE.Vector2(sr.points[k].x,sr.points[k].y));var surface={id:sr.id,points:californiaPts,room_id:sr.room_id,icon_name:sr.icon_name,get color(){return this.scene_obj.material.color.getHex();},set color(c){return this.scene_obj.material.color.setHex(c);},__calc_positions:function(){var pc=new THREE.Vector2(0,0);var c=0;for(var k in this.points){pc.add(this.points[k]);c++;}pc.divideScalar(c);var p=[];for(var k in this.points)p.push(this.points[k].clone().sub(pc));return{pc:pc,ps:p};}};var pcs=surface.__calc_positions();var surface_shape=new THREE.Shape(pcs.ps);geometry=new THREE.ShapeGeometry(surface_shape);mesh=new THREE.Mesh(geometry,new THREE.MeshLambertMaterial({color:data.colors.subtypes[sr.color_id].color,side:THREE.BackSide}));surface.scene_obj=mesh;mesh.userData={type:'surface',surface:surface,color:surface.color};mesh.name='surface-'+sr.id;mesh.rotation.set(Math.PI/2,0,0);var room_surf_y=-opt.wall_height/2+opt.level_offset_y;mesh.position.set(pcs.pc.x,room_surf_y,pcs.pc.y);scene.add(mesh);var create_css2d_text=function(text,surface){if(text==void 0&&surface.icon_name==void 0)return;var text_pos=surface.scene_obj.position.clone();text_pos.setY(text_pos.y+opt.text_h*opt.wall_height);var icon=surface.icon_name!=void 0?'<img class="fme2-icon" src="'+FME2.ICON_DATA.byname[surface.icon_name].file+'">':'';var text_content=icon+(text==void 0?'':'<font class="fme2-label">'+text+'</font><br>');var obj3d=FME2.CSSXD.createCSS2DObject(text_content,text_pos,{},{});surface.text_3d=obj3d;obj3d.userData={type:'text',surface:surface};obj3d.name='text-'+text+'-s'+surface.id;scene.add(obj3d);return obj3d;};if(surface.room_id!=void 0){mesh.name+='-r'+surface.room_id;var shgeo_h=opt.shape_height+1;var shgeo=new THREE.ExtrudeGeometry(surface_shape,{amount:shgeo_h,bevelEnabled:false});var shmesh=new THREE.Mesh(shgeo,new THREE.MeshLambertMaterial({color:opt.selected_color,transparent:true,opacity:opt.selected_opacity}));shmesh.visible=false;shmesh.position.copy(mesh.position);shmesh.position.setY(opt.shape_height+room_surf_y);shmesh.rotation.copy(mesh.rotation);scene.add(shmesh);shmesh.userData={type:'shape',surface:surface};shmesh.name='shape_of-s'+sr.id+'-r'+surface.room_id;mesh.userData.shape=shmesh;level.surfaces[sr.id]=surface;surface.scene_shape=shmesh;var room=rooms[lvl.build_id][surface.room_id];surface.room=room;if(room.MULTI==1)surface.icon_name='projector';var obj3d=create_css2d_text(room.NUM,surface);if(room_obj3d[level_blid(lvl)]==void 0)room_obj3d[level_blid(lvl)]=[];room_obj3d[level_blid(lvl)].push(obj3d);assign_surfroom[surface.room_id]=surface;}else{create_css2d_text(undefined,surface);}}material=new THREE.MeshLambertMaterial({color:main_wall_color,transparent:false,opacity:0.5});var mergregeo=new THREE.Geometry();for(var w in level.walls){mesh=level.walls[w].scene_obj;mesh.updateMatrix();mergregeo.merge(mesh.geometry,mesh.matrix);}for(var n in level.nodes){mesh=level.nodes[n].scene_obj;mesh.updateMatrix();mergregeo.merge(mesh.geometry,mesh.matrix);}mergregeo.mergeVertices();var merged_meshes=new THREE.Mesh(mergregeo,material);merged_meshes.name='merged';scene.add(merged_meshes);current_level=level;loaded_levels[level_blid(level)]=level;look_at_me();console.log('Cached level '+level_blid(lvl));console.timeEnd('load_packed_level');if(schedule_prm.enabled)schedule_changed_level();}var room_blink={id:undefined,status:false,mesh:undefined,prev_color:undefined};function room_clear_blink(){if(room_blink.id==void 0)return;clearInterval(room_blink.id);if(room_blink.status)if(schedule_prm.enabled)schedule_changed_level();room_blink.id=undefined;room_blink.status=false;var mesh=room_blink.mesh;if(mesh!=void 0){mesh.material.color.setHex(room_blink.prev_color);select_shape_view(mesh,false);}}function room_blinker(){var status=room_blink.status;if(room_blink.mesh!=void 0){room_blink.mesh.material.color.setHex(opt.selected_color);if(status)select_shape_view(room_blink.mesh,true);else select_shape_view(room_blink.mesh,false);}room_blink.status=!status;}function blink_room_id(room_id){var box=assign_surfroom[room_id];if(box==void 0)return;box=box.scene_shape;room_blink.mesh=box;room_blink.prev_color=box.material.color.getHex();room_blink.status=true;room_blink.id=setInterval(room_blinker,1000);controls.target=box.position.clone();controls.update();}function blink_room(name,no_blink){if(name==void 0)return;room_clear_blink();$.post(server_address+"getRoomByName",{'name':name}).done(function(dat){var data_a=JSON.parse(dat);if(data_a.error!=undefined){console.error('getRoomByName failed '+name+' [server]: '+data_a.error);alert(data_a.error);select_build(current_build_id,load_level,[current_build_id,1]);return;}data_a=data_a[0];select_build(data_a.BUILD,function(level_id,room_id){load_level(current_build_id,level_id);if(no_blink!=true)blink_room_id(room_id);},[data_a.FLOOR,data_a.ID]);}).fail(function(dat){console.error('getRoomByName failed '+name+':\n'+dat);});}var search_room_visible=false;function onSearchRoomSwitch(){if(search_room_visible){$('#search_room').hide();$('#search_room_btn').removeClass('active');search_room_visible=false;navi.enable=true;naviModeSwitch();}else{$('#search_room').show();$('#search_room_name').focus();$('#search_room_btn').addClass('active');search_room_visible=true;}}function setSearchRoomBuild(b){X.GEBI('search_room_build').innerHTML=b;}function onSearchRoom(){var room=X.GEBI('search_room_build').innerHTML;var name=X.GEBI('search_room_name').value;if(name==''){select_build(room,load_level,[room,'1']);return;}room=room+'-'+name;if(room!='-')blink_room(room);}function select_build(build_id,callback,callback_args){if(data.builds==void 0||data.builds[build_id]==void 0){$.post(server_address+"getRoomsOfBuild",{'b':build_id}).done(function(dat){var data_rooms=JSON.parse(dat);if(data_rooms.error!=undefined){console.error('Load rooms failed of build '+build_id+'[server]: '+data_rooms.error);return;}rooms[build_id]={};for(var i in data_rooms){var room=data_rooms[i];rooms[build_id][room.ID]=room;}var type=build_id*10;$.post(server_address+"admin/getMapEditorData",{'type':type}).done(function(dat){var data_b=JSON.parse(dat)['data'];data.builds[build_id]=data_b;current_build_id=build_id;load_level_selector(build_id);if(callback!=void 0)callback.apply(this,callback_args);}).fail(function(dat){console.timeEnd('Load '+type);console.error('Data load failed ['+type+']:\n'+dat);});}).fail(function(dat){console.error('Load rooms failed of build '+build_id);});}else{current_build_id=build_id;load_level_selector(build_id);if(callback!=void 0)callback.apply(this,callback_args);}}var selectors_visible=false;function level_selectors_switch(){if(selectors_visible){$('#build_selector').show();$('#level_selector').show();$('#level_selectors_btn').addClass('active');selectors_visible=false;}else{$('#build_selector').hide();$('#level_selector').hide();$('#level_selectors_btn').removeClass('active');selectors_visible=true;}}function load_level_selector(build_id){var lids=X.GET_VALUES_OF_KEYS_IN_DIC(data.builds[build_id],'level_id');lids.reverse();var container=document.getElementById('level_selector');container.innerHTML='';var html='';for(var k in lids){html+='<span class="fme2-button btn-selecter" id="select-level-'+lids[k]+'" onclick="load_level(current_build_id, this.innerHTML);">'+lids[k]+'</span>';container.innerHTML+=html;}container.innerHTML=html;}function load_build_selector(bids){bids.reverse();var container=document.getElementById('build_selector');container.innerHTML='';var html='';for(var k in bids){html+='<span class="fme2-button btn-selecter" id="select-build-'+bids[k]+'" onclick="select_build(this.innerHTML);">'+bids[k]+'</span>';}container.innerHTML=html;}function camera_targeting(){var intersect=rayGetIntersects({offsetX:render_width()/2,offsetY:render_height()/2},[background])[0];if(intersect!=void 0){controls.target.copy(intersect.point);controls.target0=controls.target.clone();controls.position0=camera.position.clone();controls.zoom0=camera.zoom;}else controls.reset();}function look_at_me(){var v=new THREE.Vector3(0,0,1);v.applyQuaternion(camera.quaternion);var meshs=room_obj3d[level_blid(current_level)];for(var r in meshs){var to=meshs[r].position.clone();to=to.add(v);meshs[r].lookAt(to);}}var mouseoff={};function on_mouse_down(event){mouseoff.offsetX=event.offsetX;mouseoff.offsetY=event.offsetY;}function on_mouse_up(event){if(Math.abs(mouseoff.offsetX-event.offsetX)<=opt.mouse_click_range&&Math.abs(mouseoff.offsetY-event.offsetY)<=opt.mouse_click_range)on_click(event);}function select_shape_view(shape,to){shape.visible=to;}var selected_shape=undefined;function clear_selected_shape(){if(selected_shape!=void 0){selected_shape.material.color.setHex(selected_shape.userData.prev_shape_color);if(selected_shape.userData.busy!=true)select_shape_view(selected_shape,false);selected_shape=undefined;}}function on_click(event){var intersect=rayGetIntersects(event,scene.children);if(intersect.length==0)return;intersect=intersect[0];clear_selected_shape();if(intersect.object.userData.type=='surface'||intersect.object.userData.type=='shape'){if(intersect.object.userData.type=='surface')selected_shape=intersect.object.userData.surface.scene_shape;else selected_shape=intersect.object;if(selected_shape!=void 0&&selected_shape.userData.surface.room_id!=void 0){room_clear_blink();selected_shape.userData.prev_shape_color=selected_shape.material.color.getHex();selected_shape.material.color.setHex(opt.selected_color);select_shape_view(selected_shape,true);show_clicked_room_schedule(selected_shape.userData.surface.room);}}}var schedule;var schedule_prm={enabled:false,my_group:"",day:1,pair:1,week:1,now_week:1,odd:1,day_str:["ПН","ВТ","СР","ЧТ","ПТ","СБ"],pair_srt:["1 пара","2 пара","3 пара","4 пара","5 пара","6 пара","7 пара"]};function schedule_callback(){schedule_prm.enabled=true;update_schedule_view(current_level.level_id,rooms[current_build_id]);}function schedule_set_day(d,run){$("#schedule_drop_down_day").html(schedule_prm.day_str[d-1]);schedule_prm.day=d;if(run&&schedule_prm.enabled){clear_schedule_select();schdeule_RUN(current_level.level_id,schedule_prm.day,schedule_prm.pair,schedule_prm.odd);}}function schedule_set_day_next(){var d=schedule_prm.day+1;if(d>6)d=6;schedule_set_day(d,true);}function schedule_set_day_prev(){var d=schedule_prm.day-1;if(d<1)d=1;schedule_set_day(d,true);}function schedule_set_pair(d,run){schedule_prm.pair=d;$("#schedule_drop_down_pair").html(schedule_prm.pair_srt[d-1]);if(run&&schedule_prm.enabled){clear_schedule_select();schdeule_RUN(current_level.level_id,schedule_prm.day,schedule_prm.pair,schedule_prm.odd);}}function schedule_set_pair_next(){var d=schedule_prm.pair+1;if(d>7)d=7;schedule_set_pair(d,true);}function schedule_set_pair_prev(){var d=schedule_prm.pair-1;if(d<1)d=1;schedule_set_pair(d,true);}function schedule_next_week(){schedule_prm.week++;schedule_set_odd(schedule_prm.week,true);}function schedule_prev_week(){schedule_prm.week--;schedule_set_odd(schedule_prm.week,true);}function schedule_cur_week(){schedule_set_odd(schedule_prm.now_week,true);}function schedule_set_odd(num,run){if(num<1)num=1;if(num>20)num=20;schedule_prm.week=num;schedule_prm.odd=num;$("#week_num").html(num+' неделя');if(run&&schedule_prm.enabled){clear_schedule_select();schdeule_RUN(current_level.level_id,schedule_prm.day,schedule_prm.pair,schedule_prm.week);}}function schdeule_RUN_TO_RUN(){schedule_callback();}function schedule_RUN_SWITCHER(){if(schedule_prm.enabled){$('#schedule_runer_btn').removeClass('active');$('#schedule_control').hide();schedule_STOP();}else{$('#schedule_runer_btn').addClass('active');$('#schedule_control').show();schedule_prm.my_group=Cookies.get('userGroup');schedule_get_week(schedule_RUN_FROM_SWITCHER);}}function schedule_RUN_FROM_SWITCHER(){schdeule_RUN(current_level.level_id,schedule_prm.day,schedule_prm.pair,schedule_prm.odd);}function schdeule_RUN(floor,day,pair,odd){schedule_prm.enabled=true;get_schedule(floor,day,pair,odd,schedule_callback);}function schedule_STOP(){schedule_prm.enabled=false;clear_schedule_select();}function getWeekNumber(termBegin){var cur=new Date;var temp=termBegin.split(/\./);var begin=new Date(temp[2],temp[1]-1,temp[0]);var weekday=begin.getDay();var d=(cur-begin)/1000/60/60/24;d=(d+weekday)/7;return parseInt(d)+1;}function schedule_set_day_pair_odd_now(week_num){var ret={};var date=new Date();ret.day=date.getDay();if(ret.day==0){ret.day++;week_num++;ret.pair=1;}else{var ps={2:9*60+55,3:11*60+35,4:13*60+15,5:15*60+10,6:16*60+50,7:18*60+30,8:20*60};var t=date.getHours()*60+date.getMinutes();ret.pair=1;for(var p in ps){if(t>ps[p])ret.pair=p;}if(ret.pair==8){ret.day=(ret.day+1)%7;if(ret.day==0){ret.day++;week_num++;}ret.pair=1;}}schedule_set_pair(ret.pair,false);schedule_set_day(ret.day,false);schedule_set_odd(week_num,false);schedule_prm.now_week=week_num;return ret;}function schedule_get_week(callback_success){$.get(server_address+"2/get_semester_begin").done(function(data){var b=getWeekNumber(JSON.parse(data).semester_begin);schedule_set_day_pair_odd_now(b);callback_success();}).fail(function(data){var err="OOPS!\nget_semestr_begin failed";console.log(err);console.log(data);});}function schedule_show_modal(info){var content=info.roomname+'<br>'+info.discname;$('#modal_sch_room_title').html(content);content="";for(var p in info.persons){var per=info.persons[p];content+='<p><a href="'+per.link+'"><u><font >'+per.name+'<font></u></a></p>';}$('#modal_sch_room_teachers').html(content);content="";for(var g in info.groups){var group=info.groups[g];content+='<p>'+group+'</p>';}$('#modal_sch_room_groups').html(content);$('#modal_sch_room').show();}function get_schedule(floor,day,pair,odd,callback_success){$.get(server_address+"getGroupsFromFloor?floor="+floor+"&day="+day+"&pair="+pair+"&odd="+odd).done(function(data){schedule=JSON.parse(data);if(callback_success!=undefined)callback_success();else console.log("callback_success is indefined");}).fail(function(data){var err="OOPS!\nSchedule loading failed\n"+"day="+day+" pair="+pair+" odd="+odd;console.log(err);console.log(data);alert(err);});}function get_schedule_info_of_room(room){var gs=schedule[room.NAME];if(gs==void 0)return undefined;var ret={};ret.roomname=room.NAME;ret.discname=gs.discname;ret.persons=gs.persons;ret.groups=gs.groups;return ret;}function get_busy_rooms(floor,rooms){var rs=[];var sch;for(var r in rooms){if(rooms[r].FLOOR==floor){sch=schedule[rooms[r].NAME];if(sch!=undefined)rs.push(rooms[r]);}}return rs;}function schedule_group_in_busy_room(group,room){var sch=schedule[room.NAME];if(sch==void 0)return false;else for(var g in sch.groups)if(sch.groups[g]===group)return true;return false;}function update_schedule_view(floor,rooms){var br=get_busy_rooms(floor,rooms);for(var broom in br){var b=br[broom];var shape=current_level.surfaces[b.SURFACE_ID];if(shape!=void 0){shape=shape.scene_shape;shape.userData.busy=true;var color=opt.selected_schedule_color;var sch=schedule[b.NAME];for(var g in sch.groups)if(schedule_prm.my_group==sch.groups[g])color=opt.selected_schedule_group_color;shape.material.color.setHex(color);select_shape_view(shape,true);}}}function show_clicked_room_schedule(room){if(schedule_prm.enabled!=true)return;var sch=get_schedule_info_of_room(room);if(sch==void 0)return;schedule_show_modal(sch);}function clear_schedule_select(){var surfaces=current_level.surfaces;for(var s in surfaces){select_shape_view(surfaces[s].scene_shape,false);surfaces[s].scene_shape.userData.busy=false;}}function schedule_changed_level(){clear_schedule_select();schedule_RUN_FROM_SWITCHER()}var navi={enable:false,mesh_level:{},nodes:undefined,mesh_path:{},from_room_id:undefined,to_room_id:undefined,to_room_name:undefined,from_room_name:undefined};function naviModeSwitch(){if(!navi.enable){$('#navi').show();$('#navi_sets').show();$('#navi_btn').addClass('active');navi.enable=true;navi_visibling_current();search_room_visible=false;onSearchRoomSwitch();}else{$('#navi').hide();$('#navi_sets').hide();$('#navi_btn').removeClass('active');navi.enable=false;navi_visibling_current();}}function onNaviSet(tofrom){var name=$('#search_room_name').val();var b=$('#search_room_build').html();var room=b+(name==""?"":'-'+name);navi[tofrom+'_room_name']=room;if(name=='')room=b+'-'+'вход';$('#navi_set_'+tofrom).html(room);if(navi.to_room_name!=void 0&&navi.from_room_name!=void 0)onGetNavi(navi.from_room_name+'/'+navi.to_room_name);}function naviClearSets(){navi.to_room_name=undefined;navi.from_room_name=undefined;$('#navi_set_to').html('');$('#navi_set_from').html('');}function onGetNavi(prms){if(prms!=void 0){var roomsp=String(prms).split('/');var room_id={};var getid=function(name,n,callback,callback_arg){var l=String(name).split('-').length;if(l==1){room_id[n]=1000000+parseInt(name);if(callback!=void 0)callback.apply(callback_arg);return;}$.post(server_address+"getRoomByName",{'name':name}).done(function(dat){var data_a=JSON.parse(dat);if(data_a.error!=undefined){console.error('getRoomByName failed '+name+' [server]: '+data_a.error);alert(data_a.error);naviClearSets();return;}data_a=data_a[0];room_id[n]=data_a.ID;if(callback!=void 0)callback.apply(callback_arg);}).fail(function(dat){naviClearSets();console.error('getRoomByName failed '+name+':\n'+dat);});};var getnavi=function(fid,tid,callback,callback_arg){$.post(server_address+"journey",{'from_room_id':fid,'to_room_id':tid}).done(function(dat){var data_a=JSON.parse(dat);if(data_a.error!=undefined){console.error('journey failed [server]: '+data_a.error);alert(data_a.error);return;}navi.nodes=data_a.nodes;navi.path=data_a.path;for(var n in navi.nodes){var p=navi.nodes[n].position;navi.nodes[n].position=new THREE.Vector3(p.x,p.y,p.z);}if(callback!=void 0)callback.apply(callback_arg);}).fail(function(dat){console.error('journey failed');});};getid(roomsp[0],0,function(){navi.from_room_id=room_id[0];getid(roomsp[1],1,function(){navi.to_room_id=room_id[1];getnavi(room_id[0],room_id[1],function(){navi.enable=true;if(room_id[0]<1000000)blink_room(roomsp[0],true);else load_level(room_id[0]%100,1);});});});}}function navi_get_mesh_level(lvl){var blid=level_blid({build_id:lvl.build_id,level_id:lvl.level_id});var mesh_level=navi.mesh_level[blid];return{mesh_level:mesh_level,blid:blid};}function navi_visibling(lvl){var mesh_level=navi_get_mesh_level(lvl);if(mesh_level.mesh_level!=void 0)mesh_level.mesh_level.visible=navi.enable;return{enable:navi.enable,mesh_level:mesh_level};}function navi_visibling_current(){return navi_visibling(current_level);}function draw_navi(build_id,level_id){var ll={build_id:build_id,level_id:level_id};var lll=navi_visibling(ll);if(!lll.enable)return;var mesh_level=lll.mesh_level.mesh_level;var blid=lll.mesh_level.blid;scene.remove(mesh_level);var id21=X.ID21(navi.from_room_id,navi.to_room_id);id21=X.ID21(id21,blid);var mesh_path=navi.mesh_path[id21];if(mesh_path!=void 0){}var group_mode=true;var material=new THREE.MeshBasicMaterial({color:opt.navi_color,transparent:true,opacity:opt.navi_opacity});var union_mesh;if(group_mode)union_mesh=new THREE.Object3D();var nodes=navi.nodes;if(nodes==void 0)return;var mergregeobsp=undefined;var p0=new THREE.Vector3(1,0,0);for(var n in navi.path){var nd=nodes[navi.path[n]];if(nd.build!=build_id||nd.level!=level_id)continue;var p=nd.position;var navi_y=opt.wall_height*(opt.navi_y-0.5);var mesh=new THREE.Mesh(new THREE.CylinderGeometry(opt.wall_width/2,opt.wall_width/2,opt.wall_height*opt.navi_h,8),material);p.setY(navi_y);mesh.position.copy(p);if(group_mode)union_mesh.add(mesh);else{if(mergregeobsp==void 0)mergregeobsp=new ThreeBSP(mesh);else{var meshbsp=new ThreeBSP(mesh);mergregeobsp=mergregeobsp.union(meshbsp);}}}var fly=[];for(var n in navi.path){n=parseInt(n);var nd1=nodes[navi.path[n]];var nd2=nodes[navi.path[n+1]];if(nd2==void 0||nd1==void 0)continue;if(nd1.build!=build_id||nd1.level!=level_id)continue;if(nd2.build!=build_id||nd2.level!=level_id)continue;var p=nd1.position;var p2=nd2.position;p2.setY(0);var p1=p;var l=p1.distanceTo(p2);var a=p1.clone().sub(p2).angleTo(p0);if(p1.z>p2.z)a=Math.PI*2-a;var pl=p1.clone().add(p2).divideScalar(2).setY(navi_y);var mesh_connect=new THREE.Mesh(new THREE.BoxGeometry(l,opt.wall_height*opt.navi_h,opt.wall_width),material.clone());mesh_connect.position.copy(pl);mesh_connect.rotation.set(0,a,0);if(group_mode)union_mesh.add(mesh_connect);else{var meshbsp=new ThreeBSP(mesh_connect);mergregeobsp=mergregeobsp.union(meshbsp);}fly.push(mesh_connect);}if(!group_mode&&mergregeobsp!=void 0){union_mesh=mergregeobsp.toMesh(material);union_mesh.geometry.computeVertexNormals();}if(union_mesh!=void 0){union_mesh.userData='navi_mesh';union_mesh.name='navi-'+navi.from_room_id+'-'+navi.to_room_id;navi.mesh_path[id21]=union_mesh;navi.mesh_level[blid]=union_mesh;scene.add(union_mesh);}navi_calc_levels();load_navi_selector();navi.fly=fly;navi_flyer_start();}function navi_flyer_start(){for(var f in navi.fly)navi.fly[f].material.color.setHex(opt.navi_color);navi.fly_index=-1;clearInterval(navi.fly_id);navi.fly_id=setInterval(navi_flyer,opt.navi_fly_timeout);}function navi_flyer(){if(navi.fly==void 0)return;var fly=navi.fly[navi.fly_index];if(fly!=void 0)fly.material.color.setHex(opt.navi_color);navi.fly_index++;if(navi.fly_index>=navi.fly.length)navi.fly_index=-1;fly=navi.fly[navi.fly_index];if(fly!=void 0)fly.material.color.setHex(opt.navi_color_fly);}function navi_calc_levels(){var levels=[];var c=0;var pb=-1;var pl=-1;for(var p in navi.path){var nid=parseInt(navi.path[p]);var l=nid%100;nid=Math.floor(nid/100);var b=nid%100;if(pb!=b||pl!=l){if(c>1)levels.push({b:pb,l:pl});c=0;}pl=l;pb=b;c++;}if(c>1&&levels.length>0)levels.push({b:pb,l:pl});navi.levels=levels;return levels;}function load_navi_selector(){$('#navi_selecter').html('');var html='';for(var l in navi.levels){var ll=navi.levels[l];var h=' <div class="fme2-button btn-levels" onclick="load_build_level('+ll.b+', '+ll.l+');">'+'Корпус '+ll.b+' : Этаж '+ll.l+'</div>';if(l==navi.levels.length-1)h=h.replace('arrow_downward','close');html+=h;}$('#navi_selecter').html(html);}var fme2_container,container,stats,camera,scene,controls,renderer,css_renderer;var cam_factor=1;function render_width(){return fme2_container.width();}function render_height(){return fme2_container.height();}var opt={level_offset_y:0,surface_y:-5,wall_height:50,wall_width:10,node_hei:1,door_top:0.2,door_color:0xBC7724,door_width:0.1,text_size:25,text_color:0,text_h:0.75,font:undefined,selected_opacity:1,selected_color:0xC83232,selected_schedule_color:0x3DBDB4,selected_schedule_group_color:0x5ABD3D,mouse_click_range:10,navi_opacity:0.7,navi_color:0,navi_color_fly:0xBB3ABA,navi_h:0.25,navi_y:0.68,navi_fly_timeout:500,shape_height:1};var loaded_levels={};var enabled_fps=false;var rooms={};var data=undefined;var raycaster=new THREE.Raycaster();var current_build_id=parseInt(X.GET_URL_PARAMETER('b'));var current_level=parseInt(X.GET_URL_PARAMETER('l'));if(isNaN(current_build_id))current_build_id=7;if(isNaN(current_level))current_level=1;navi.enable=true;naviModeSwitch();level_selectors_switch();$('#schedule_control').hide();$('#search_room').hide();X.GEBI('search_room_name').onkeypress=function(client_event){if(client_event.keyCode==13)onSearchRoom();};$('#level_selectors_btn').click();$.post(server_address+"admin/getMapEditorData",{'type':0}).done(function(dat){data=JSON.parse(dat);if(data.error!=void 0){alert('Data load failed [server]: '+data.error);return;}data=data['data'];data.builds={};load_build_selector(data.build_ids);init();}).fail(function(dat){console.error('Data load failed:\n'+dat);});function init(){console.time('init');fme2_container=$('#fme2_container');container=document.getElementById('render_container');camera=new THREE.OrthographicCamera(-render_width()*cam_factor,render_width()*cam_factor,render_height()*cam_factor,-render_height()*cam_factor,-2000,100000);camera.position.x=-2000;camera.position.y=2000;camera.position.z=2000;scene=undefined;renderer=new THREE.WebGLRenderer({antialias:true,logarithmicDepthBuffer:false,preserveDrawingBuffer:true});renderer.setClearColor(0xffffff);renderer.setSize(render_width(),render_height());renderer.domElement.addEventListener('mouseup',camera_targeting,false);renderer.domElement.addEventListener('mousedown',on_mouse_down,false);renderer.domElement.addEventListener('mouseup',on_mouse_up,false);container.appendChild(renderer.domElement);controls=new THREE.OrbitControls(camera,renderer.domElement);if(X.GET_URL_PARAMETER('unc')!=true){controls.maxPolarAngle=Math.PI*0.4;controls.minZoom=0.7;controls.maxZoom=3;}enabled_fps=false;stats=new Stats();stats.dom.style.position='absolute';stats.dom.style.marginLeft='0px';stats.dom.style.marginTop='0px';stats.dom.id='fps';stats.dom.style.display='none';document.getElementById('fme2_container').appendChild(stats.dom);if(X.GET_URL_PARAMETER('fps')){stats.dom.style.display='block';enabled_fps=true;}window.addEventListener('resize',onWindowResize,false);var selroom=X.GET_URL_PARAMETER('room');if(selroom==void 0)select_build(current_build_id,load_level,[current_build_id,current_level]);else blink_room(selroom);animate();console.timeEnd('init');}function onWindowResize(){camera.left=-render_width()*cam_factor;camera.right=render_width()*cam_factor;camera.top=render_height()*cam_factor;camera.bottom=-render_height()*cam_factor;camera.updateProjectionMatrix();renderer.setSize(render_width(),render_height());if(css_renderer!=void 0)css_renderer.setSize(render_width(),render_height());}function animate(){requestAnimationFrame(animate);if(scene!=void 0){renderer.render(scene,camera);if(css_renderer!=void 0)css_renderer.render(scene,camera);}stats.update();}function fps_show(){$('#fps').show();}function fps_hide(){$('#fps').hide();}function rayGetIntersects(client_event,objects){if(client_event==void 0)return{length:0};if(objects==void 0)return{length:0};var x=client_event.offsetX;var y=client_event.offsetY;if(x<0||x>render_width()||y<0||y>render_height())return{length:0};y=render_height()-y;x=x/render_width()*2-1;y=y/render_height()*2-1;var ray_mouse=new THREE.Vector2(x,y);raycaster.setFromCamera(ray_mouse,camera);var intersects=raycaster.intersectObjects(objects);intersects=intersects||{length:0};return intersects;}